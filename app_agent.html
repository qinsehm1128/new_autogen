<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoGen WebSocket èŠå¤©åº”ç”¨</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            background-color: #f0f2f5;
        }

        #chat-container {
            width: 90%;
            max-width: 800px;
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            padding: 20px;
            display: flex;
            flex-direction: column;
            height: 80vh;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e8e8e8;
        }

        .header h1 {
            margin: 0;
            color: #1890ff;
            font-size: 24px;
        }

        .header .subtitle {
            color: #666;
            font-size: 14px;
            margin-top: 5px;
        }

        #messages {
            flex: 1;
            overflow-y: auto;
            border: 1px solid #e8e8e8;
            border-radius: 8px;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #fafafa;
        }

        .message {
            margin: 15px 0;
            padding: 12px;
            border-radius: 8px;
            position: relative;
        }

        .message.user {
            background-color: #e6f7ff;
            border-left: 4px solid #1890ff;
        }

        .message.assistant {
            background-color: #f6ffed;
            border-left: 4px solid #52c41a;
        }

        .message.error {
            color: #721c24;
            background-color: #fff2f0;
            border-left: 4px solid #ff4d4f;
        }

        .message.system {
            color: #0958d9;
            background-color: #f0f5ff;
            border-left: 4px solid #722ed1;
        }

        .streaming {
            opacity: 0.8;
            border-left: 4px solid #faad14 !important;
            position: relative;
        }

        .streaming::after {
            content: "æ­£åœ¨è¾“å…¥...";
            position: absolute;
            right: 10px;
            top: 10px;
            font-size: 12px;
            color: #faad14;
            animation: blink 1s infinite;
        }

        @keyframes blink {

            0%,
            50% {
                opacity: 1;
            }

            51%,
            100% {
                opacity: 0.3;
            }
        }

        .message-label {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .message-content {
            line-height: 1.6;
            word-wrap: break-word;
        }

        .token-info {
            font-size: 12px;
            color: #999;
            margin-top: 8px;
            font-style: italic;
            text-align: right;
        }

        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }

        .connected {
            background-color: #f6ffed;
            color: #389e0d;
            border: 1px solid #b7eb8f;
        }

        .disconnected {
            background-color: #fff2f0;
            color: #cf1322;
            border: 1px solid #ffccc7;
        }

        #input-container {
            display: flex;
            gap: 10px;
            align-items: stretch;
        }

        #message-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #d9d9d9;
            border-radius: 6px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s;
        }

        #message-input:focus {
            border-color: #1890ff;
        }

        #message-input:disabled {
            background-color: #f5f5f5;
            cursor: not-allowed;
        }

        .button {
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 80px;
        }

        .button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        #send-btn {
            background-color: #1890ff;
            color: white;
        }

        #send-btn:hover:not(:disabled) {
            background-color: #40a9ff;
        }

        #terminate-btn {
            background-color: #ff4d4f;
            color: white;
        }

        #terminate-btn:hover:not(:disabled) {
            background-color: #ff7875;
        }

        .controls-info {
            margin-top: 10px;
            font-size: 12px;
            color: #999;
            text-align: center;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            #chat-container {
                width: 95%;
                height: 90vh;
                padding: 15px;
            }

            .header h1 {
                font-size: 20px;
            }

            #input-container {
                flex-direction: column;
            }

            .button {
                width: 100%;
            }
        }
    </style>
</head>

<body>
    <!-- è¿æ¥çŠ¶æ€æŒ‡ç¤ºå™¨ -->
    <div class="connection-status" id="connection-status">
        ğŸ”´ æœªè¿æ¥
    </div>

    <!-- ä¸»èŠå¤©å®¹å™¨ -->
    <div id="chat-container">
        <!-- å¤´éƒ¨æ ‡é¢˜ -->
        <div class="header">
            <h1>ğŸ¤– AutoGen AI åŠ©æ‰‹</h1>
            <div class="subtitle">æ”¯æŒæµå¼å“åº”ä¸å³æ—¶ç»ˆæ­¢çš„æ™ºèƒ½èŠå¤©</div>
        </div>

        <!-- æ¶ˆæ¯æ˜¾ç¤ºåŒºåŸŸ -->
        <div id="messages"></div>

        <!-- è¾“å…¥åŒºåŸŸ -->
        <div id="input-container">
            <input type="text" id="message-input" placeholder="è¾“å…¥æ‚¨çš„æ¶ˆæ¯...æŒ‰å›è½¦å‘é€">
            <button class="button" id="send-btn" onclick="sendMessage()">ğŸ“¤ å‘é€</button>
            <button class="button" id="terminate-btn" onclick="terminateChat()">â›” ç»ˆæ­¢</button>
        </div>

        <!-- æ§åˆ¶è¯´æ˜ -->
        <div class="controls-info">
            ğŸ’¡ æç¤ºï¼šæŒ‰å›è½¦é”®å¿«é€Ÿå‘é€ï¼Œç»ˆæ­¢æŒ‰é’®éšæ—¶å¯ç”¨ï¼Œå¯ç«‹å³åœæ­¢AIå“åº”
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let socket = null;  // WebSocketè¿æ¥å¯¹è±¡
        let currentStreamingMessage = null;  // å½“å‰æ­£åœ¨æµå¼æ˜¾ç¤ºçš„æ¶ˆæ¯å…ƒç´ 
        let isWaitingForResponse = false;  // æ˜¯å¦æ­£åœ¨ç­‰å¾…å“åº”

        /**
         * è¿æ¥WebSocketæœåŠ¡å™¨
         */
        function connectWebSocket() {
            // åˆ›å»ºWebSocketè¿æ¥
            socket = new WebSocket('ws://localhost:8001/ws');

            // è¿æ¥æ‰“å¼€äº‹ä»¶
            socket.onopen = function (event) {
                console.log('âœ… WebSocketè¿æ¥å·²å»ºç«‹');
                updateConnectionStatus(true);
                loadHistory();  // åŠ è½½å†å²è®°å½•
            };

            // æ¥æ”¶æ¶ˆæ¯äº‹ä»¶
            socket.onmessage = function (event) {
                const data = JSON.parse(event.data);
                handleWebSocketMessage(data);
            };

            // è¿æ¥å…³é—­äº‹ä»¶
            socket.onclose = function (event) {
                console.log('âŒ WebSocketè¿æ¥å·²æ–­å¼€');
                updateConnectionStatus(false);
                // 3ç§’åå°è¯•é‡æ–°è¿æ¥
                setTimeout(connectWebSocket, 3000);
            };

            // è¿æ¥é”™è¯¯äº‹ä»¶
            socket.onerror = function (error) {
                console.error('ğŸš« WebSocketé”™è¯¯:', error);
                updateConnectionStatus(false);
            };
        }

        /**
         * æ›´æ–°è¿æ¥çŠ¶æ€æ˜¾ç¤º
         * @param {boolean} connected - æ˜¯å¦å·²è¿æ¥
         */
        function updateConnectionStatus(connected) {
            const statusElement = document.getElementById('connection-status');
            if (connected) {
                statusElement.textContent = 'ğŸŸ¢ å·²è¿æ¥';
                statusElement.className = 'connection-status connected';
            } else {
                statusElement.textContent = 'ğŸ”´ æœªè¿æ¥';
                statusElement.className = 'connection-status disconnected';
            }
        }

        /**
         * å¤„ç†WebSocketæ¶ˆæ¯
         * @param {Object} data - æ¥æ”¶åˆ°çš„æ¶ˆæ¯æ•°æ®
         */
        function handleWebSocketMessage(data) {
            switch (data.type) {
                case 'user_message':
                    // ç”¨æˆ·æ¶ˆæ¯ç¡®è®¤ - å·²ç»æ˜¾ç¤ºè¿‡äº†
                    break;

                case 'response_start':
                    // å¼€å§‹æµå¼å“åº”
                    currentStreamingMessage = createStreamingMessage();
                    isWaitingForResponse = false;
                    enableControls();
                    break;

                case 'chunk':
                    // æ·»åŠ æ•°æ®å—åˆ°æµå¼æ¶ˆæ¯
                    if (currentStreamingMessage) {
                        appendToStreamingMessage(currentStreamingMessage, data.content);
                    }
                    break;

                case 'response_complete':
                    // å®Œæˆæµå¼æ¶ˆæ¯
                    if (currentStreamingMessage) {
                        completeStreamingMessage(currentStreamingMessage, data);
                        currentStreamingMessage = null;
                    }
                    break;

                case 'terminated':
                    displayMessage(data.content, 'system');
                    if (currentStreamingMessage) {
                        completeStreamingMessage(currentStreamingMessage, {
                            content: "[å“åº”å·²ç»ˆæ­¢]",
                            token_count: 0,
                            character_count: 0
                        });
                        currentStreamingMessage = null;
                    }
                    enableControls();
                    isWaitingForResponse = false;
                    break;

                case 'error':
                    displayMessage(data.content, 'error');
                    enableControls();
                    isWaitingForResponse = false;
                    break;

                case 'system':
                    displayMessage(data.content, 'system');
                    break;
            }
        }

        /**
         * åˆ›å»ºæµå¼æ¶ˆæ¯å…ƒç´ 
         * @returns {HTMLElement} æ¶ˆæ¯å…ƒç´ 
         */
        function createStreamingMessage() {
            const messagesContainer = document.getElementById('messages');
            const messageElement = document.createElement('div');
            messageElement.className = 'message assistant streaming';

            const labelElement = document.createElement('div');
            labelElement.className = 'message-label';
            labelElement.textContent = 'ğŸ¤– AIåŠ©æ‰‹';

            const contentElement = document.createElement('div');
            contentElement.className = 'message-content';
            contentElement.textContent = '';

            messageElement.appendChild(labelElement);
            messageElement.appendChild(contentElement);
            messagesContainer.appendChild(messageElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            return messageElement;
        }

        /**
         * å‘æµå¼æ¶ˆæ¯è¿½åŠ å†…å®¹
         * @param {HTMLElement} messageElement - æ¶ˆæ¯å…ƒç´ 
         * @param {string} content - è¦è¿½åŠ çš„å†…å®¹
         */
        function appendToStreamingMessage(messageElement, content) {
            const contentElement = messageElement.querySelector('.message-content');
            contentElement.textContent += content;

            // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
            const messagesContainer = document.getElementById('messages');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        /**
         * å®Œæˆæµå¼æ¶ˆæ¯æ˜¾ç¤º
         * @param {HTMLElement} messageElement - æ¶ˆæ¯å…ƒç´ 
         * @param {Object} data - å®Œæˆæ•°æ®ï¼ŒåŒ…å«ä»¤ç‰Œä¿¡æ¯
         */
        function completeStreamingMessage(messageElement, data) {
            messageElement.classList.remove('streaming');

            // æ·»åŠ ä»¤ç‰Œä¿¡æ¯
            if (data.token_count !== undefined) {
                const tokenInfo = document.createElement('div');
                tokenInfo.className = 'token-info';
                tokenInfo.textContent = `ğŸ“Š ä»¤ç‰Œ: ${data.token_count} | å­—ç¬¦: ${data.character_count}`;
                messageElement.appendChild(tokenInfo);
            }
        }

        /**
         * å‘é€æ¶ˆæ¯
         */
        function sendMessage() {
            const input = document.getElementById('message-input');
            const message = input.value.trim();

            // æ£€æŸ¥è¾“å…¥å’Œè¿æ¥çŠ¶æ€
            if (!message || !socket || socket.readyState !== WebSocket.OPEN) {
                if (!message) {
                    alert('è¯·è¾“å…¥æ¶ˆæ¯å†…å®¹ï¼');
                } else if (!socket || socket.readyState !== WebSocket.OPEN) {
                    alert('WebSocketè¿æ¥æœªå»ºç«‹ï¼Œè¯·ç­‰å¾…è¿æ¥æˆ–åˆ·æ–°é¡µé¢ï¼');
                }
                return;
            }

            // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
            displayMessage(message, 'user');

            // é€šè¿‡WebSocketå‘é€æ¶ˆæ¯
            socket.send(JSON.stringify({
                content: message,
                source: 'user'
            }));

            // æ¸…ç©ºè¾“å…¥æ¡†å¹¶ç¦ç”¨æ§ä»¶
            input.value = '';
            disableControls();
            isWaitingForResponse = true;
        }

        /**
 * ç»ˆæ­¢èŠå¤©
 */
        async function terminateChat() {
            try {
                // æ£€æŸ¥æ˜¯å¦æœ‰æ­£åœ¨è¿›è¡Œçš„å¯¹è¯
                const hasActiveConversation = currentStreamingMessage || isWaitingForResponse;

                // é€šè¿‡HTTP APIç»ˆæ­¢æ‰€æœ‰æ´»è·ƒçš„èŠå¤©
                const response = await fetch('http://localhost:8001/terminate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const result = await response.json();

                    if (hasActiveConversation) {
                        displayMessage('â›” ç”¨æˆ·æ‰‹åŠ¨ç»ˆæ­¢å“åº” - ' + result.status, 'system');

                        // å¦‚æœæœ‰æ­£åœ¨æµå¼æ˜¾ç¤ºçš„æ¶ˆæ¯ï¼Œç«‹å³å®Œæˆå®ƒ
                        if (currentStreamingMessage) {
                            completeStreamingMessage(currentStreamingMessage, {
                                content: "[ç”¨æˆ·æ‰‹åŠ¨ç»ˆæ­¢]",
                                token_count: 0,
                                character_count: 0
                            });
                            currentStreamingMessage = null;
                        }

                        // é‡æ–°å¯ç”¨æ§ä»¶
                        enableControls();
                        isWaitingForResponse = false;
                    } else {
                        // æ²¡æœ‰æ´»è·ƒå¯¹è¯æ—¶çš„æç¤º
                        displayMessage('â›” ç»ˆæ­¢ä¿¡å·å·²å‘é€ï¼ˆå½“å‰æ²¡æœ‰æ´»è·ƒçš„å¯¹è¯ï¼‰', 'system');
                    }
                } else {
                    displayMessage('âŒ ç»ˆæ­¢è¯·æ±‚å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('ç»ˆæ­¢è¯·æ±‚é”™è¯¯:', error);
                displayMessage('âŒ æ— æ³•å‘é€ç»ˆæ­¢è¯·æ±‚ï¼š' + error.message, 'error');
            }
        }

        /**
         * ç¦ç”¨æ§ä»¶
         */
        function disableControls() {
            document.getElementById('message-input').disabled = true;
            document.getElementById('send-btn').disabled = true;
            // ç»ˆæ­¢æŒ‰é’®å§‹ç»ˆä¿æŒå¯ç”¨
            document.getElementById('terminate-btn').disabled = false;
        }

        /**
         * å¯ç”¨æ§ä»¶
         */
        function enableControls() {
            const input = document.getElementById('message-input');
            const sendBtn = document.getElementById('send-btn');
            const terminateBtn = document.getElementById('terminate-btn');

            input.disabled = false;
            sendBtn.disabled = false;
            // ç»ˆæ­¢æŒ‰é’®å§‹ç»ˆä¿æŒå¯ç”¨
            terminateBtn.disabled = false;
            input.focus();  // è‡ªåŠ¨èšç„¦åˆ°è¾“å…¥æ¡†
        }

        /**
         * æ˜¾ç¤ºæ¶ˆæ¯
         * @param {string} content - æ¶ˆæ¯å†…å®¹
         * @param {string} source - æ¶ˆæ¯æ¥æºï¼ˆuser/assistant/system/errorï¼‰
         */
        function displayMessage(content, source) {
            const messagesContainer = document.getElementById('messages');
            const messageElement = document.createElement('div');
            messageElement.className = `message ${source}`;

            const labelElement = document.createElement('div');
            labelElement.className = 'message-label';

            // æ ¹æ®æ¥æºè®¾ç½®ä¸åŒçš„æ ‡ç­¾
            switch (source) {
                case 'user':
                    labelElement.textContent = 'ğŸ‘¤ ç”¨æˆ·';
                    break;
                case 'assistant':
                    labelElement.textContent = 'ğŸ¤– AIåŠ©æ‰‹';
                    break;
                case 'system':
                    labelElement.textContent = 'âš™ï¸ ç³»ç»Ÿ';
                    break;
                case 'error':
                    labelElement.textContent = 'âŒ é”™è¯¯';
                    break;
                default:
                    labelElement.textContent = source;
            }

            const contentElement = document.createElement('div');
            contentElement.className = 'message-content';
            contentElement.textContent = content;

            messageElement.appendChild(labelElement);
            messageElement.appendChild(contentElement);
            messagesContainer.appendChild(messageElement);

            // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        /**
         * åŠ è½½èŠå¤©å†å²
         */
        async function loadHistory() {
            try {
                const response = await fetch('http://localhost:8001/history');
                if (!response.ok) {
                    throw new Error('ç½‘ç»œå“åº”ä¸æ­£å¸¸');
                }
                const history = await response.json();

                // æ¸…ç©ºæ¶ˆæ¯å®¹å™¨
                document.getElementById('messages').innerHTML = '';

                // æ˜¾ç¤ºå†å²æ¶ˆæ¯
                history.forEach(message => {
                    displayMessage(message.content, message.source);
                });
            } catch (error) {
                console.error('åŠ è½½å†å²è®°å½•æ—¶å‡ºé”™:', error);
                displayMessage('âš ï¸ æ— æ³•åŠ è½½å†å²è®°å½•', 'system');
            }
        }

        // äº‹ä»¶ç›‘å¬å™¨è®¾ç½®
        document.addEventListener('DOMContentLoaded', function () {
            // å›è½¦é”®å‘é€æ¶ˆæ¯
            document.getElementById('message-input').addEventListener('keydown', function (event) {
                if (event.key === 'Enter' && !isWaitingForResponse) {
                    event.preventDefault();  // é˜²æ­¢è¡¨å•æäº¤
                    sendMessage();
                }
            });

            // åˆå§‹åŒ–æŒ‰é’®çŠ¶æ€
            document.getElementById('message-input').disabled = false;
            document.getElementById('send-btn').disabled = false;
            document.getElementById('terminate-btn').disabled = false;  // ç»ˆæ­¢æŒ‰é’®å§‹ç»ˆå¯ç”¨

            // é¡µé¢åŠ è½½æ—¶è¿æ¥WebSocket
            connectWebSocket();

            // æ˜¾ç¤ºæ¬¢è¿æ¶ˆæ¯
            setTimeout(() => {
                displayMessage('ğŸ‰ æ¬¢è¿ä½¿ç”¨AutoGen AIåŠ©æ‰‹ï¼æˆ‘å¯ä»¥ä¸ºæ‚¨æä¾›å„ç§å¸®åŠ©ã€‚ç»ˆæ­¢æŒ‰é’®éšæ—¶å¯ç”¨ï¼Œç‚¹å‡»å¯ç«‹å³åœæ­¢AIå“åº”ç”Ÿæˆã€‚', 'system');
            }, 1000);
        });

        // é¡µé¢å¸è½½æ—¶æ¸…ç†WebSocketè¿æ¥
        window.addEventListener('beforeunload', function () {
            if (socket) {
                socket.close();
            }
        });
    </script>
</body>

</html>