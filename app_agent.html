<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoGen WebSocket 聊天应用</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            background-color: #f0f2f5;
        }

        #chat-container {
            width: 90%;
            max-width: 800px;
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            padding: 20px;
            display: flex;
            flex-direction: column;
            height: 80vh;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e8e8e8;
        }

        .header h1 {
            margin: 0;
            color: #1890ff;
            font-size: 24px;
        }

        .header .subtitle {
            color: #666;
            font-size: 14px;
            margin-top: 5px;
        }

        #messages {
            flex: 1;
            overflow-y: auto;
            border: 1px solid #e8e8e8;
            border-radius: 8px;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #fafafa;
        }

        .message {
            margin: 15px 0;
            padding: 12px;
            border-radius: 8px;
            position: relative;
        }

        .message.user {
            background-color: #e6f7ff;
            border-left: 4px solid #1890ff;
        }

        .message.assistant {
            background-color: #f6ffed;
            border-left: 4px solid #52c41a;
        }

        .message.error {
            color: #721c24;
            background-color: #fff2f0;
            border-left: 4px solid #ff4d4f;
        }

        .message.system {
            color: #0958d9;
            background-color: #f0f5ff;
            border-left: 4px solid #722ed1;
        }

        .streaming {
            opacity: 0.8;
            border-left: 4px solid #faad14 !important;
            position: relative;
        }

        .streaming::after {
            content: "正在输入...";
            position: absolute;
            right: 10px;
            top: 10px;
            font-size: 12px;
            color: #faad14;
            animation: blink 1s infinite;
        }

        @keyframes blink {

            0%,
            50% {
                opacity: 1;
            }

            51%,
            100% {
                opacity: 0.3;
            }
        }

        .message-label {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .message-content {
            line-height: 1.6;
            word-wrap: break-word;
        }

        .token-info {
            font-size: 12px;
            color: #999;
            margin-top: 8px;
            font-style: italic;
            text-align: right;
        }

        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }

        .connected {
            background-color: #f6ffed;
            color: #389e0d;
            border: 1px solid #b7eb8f;
        }

        .disconnected {
            background-color: #fff2f0;
            color: #cf1322;
            border: 1px solid #ffccc7;
        }

        #input-container {
            display: flex;
            gap: 10px;
            align-items: stretch;
        }

        #message-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #d9d9d9;
            border-radius: 6px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s;
        }

        #message-input:focus {
            border-color: #1890ff;
        }

        #message-input:disabled {
            background-color: #f5f5f5;
            cursor: not-allowed;
        }

        .button {
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 80px;
        }

        .button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        #send-btn {
            background-color: #1890ff;
            color: white;
        }

        #send-btn:hover:not(:disabled) {
            background-color: #40a9ff;
        }

        #terminate-btn {
            background-color: #ff4d4f;
            color: white;
        }

        #terminate-btn:hover:not(:disabled) {
            background-color: #ff7875;
        }

        .controls-info {
            margin-top: 10px;
            font-size: 12px;
            color: #999;
            text-align: center;
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            #chat-container {
                width: 95%;
                height: 90vh;
                padding: 15px;
            }

            .header h1 {
                font-size: 20px;
            }

            #input-container {
                flex-direction: column;
            }

            .button {
                width: 100%;
            }
        }
    </style>
</head>

<body>
    <!-- 连接状态指示器 -->
    <div class="connection-status" id="connection-status">
        🔴 未连接
    </div>

    <!-- 主聊天容器 -->
    <div id="chat-container">
        <!-- 头部标题 -->
        <div class="header">
            <h1>🤖 AutoGen AI 助手</h1>
            <div class="subtitle">支持流式响应与即时终止的智能聊天</div>
        </div>

        <!-- 消息显示区域 -->
        <div id="messages"></div>

        <!-- 输入区域 -->
        <div id="input-container">
            <input type="text" id="message-input" placeholder="输入您的消息...按回车发送">
            <button class="button" id="send-btn" onclick="sendMessage()">📤 发送</button>
            <button class="button" id="terminate-btn" onclick="terminateChat()">⛔ 终止</button>
        </div>

        <!-- 控制说明 -->
        <div class="controls-info">
            💡 提示：按回车键快速发送，终止按钮随时可用，可立即停止AI响应
        </div>
    </div>

    <script>
        // 全局变量
        let socket = null;  // WebSocket连接对象
        let currentStreamingMessage = null;  // 当前正在流式显示的消息元素
        let isWaitingForResponse = false;  // 是否正在等待响应

        /**
         * 连接WebSocket服务器
         */
        function connectWebSocket() {
            // 创建WebSocket连接
            socket = new WebSocket('ws://localhost:8001/ws');

            // 连接打开事件
            socket.onopen = function (event) {
                console.log('✅ WebSocket连接已建立');
                updateConnectionStatus(true);
                loadHistory();  // 加载历史记录
            };

            // 接收消息事件
            socket.onmessage = function (event) {
                const data = JSON.parse(event.data);
                handleWebSocketMessage(data);
            };

            // 连接关闭事件
            socket.onclose = function (event) {
                console.log('❌ WebSocket连接已断开');
                updateConnectionStatus(false);
                // 3秒后尝试重新连接
                setTimeout(connectWebSocket, 3000);
            };

            // 连接错误事件
            socket.onerror = function (error) {
                console.error('🚫 WebSocket错误:', error);
                updateConnectionStatus(false);
            };
        }

        /**
         * 更新连接状态显示
         * @param {boolean} connected - 是否已连接
         */
        function updateConnectionStatus(connected) {
            const statusElement = document.getElementById('connection-status');
            if (connected) {
                statusElement.textContent = '🟢 已连接';
                statusElement.className = 'connection-status connected';
            } else {
                statusElement.textContent = '🔴 未连接';
                statusElement.className = 'connection-status disconnected';
            }
        }

        /**
         * 处理WebSocket消息
         * @param {Object} data - 接收到的消息数据
         */
        function handleWebSocketMessage(data) {
            switch (data.type) {
                case 'user_message':
                    // 用户消息确认 - 已经显示过了
                    break;

                case 'response_start':
                    // 开始流式响应
                    currentStreamingMessage = createStreamingMessage();
                    isWaitingForResponse = false;
                    enableControls();
                    break;

                case 'chunk':
                    // 添加数据块到流式消息
                    if (currentStreamingMessage) {
                        appendToStreamingMessage(currentStreamingMessage, data.content);
                    }
                    break;

                case 'response_complete':
                    // 完成流式消息
                    if (currentStreamingMessage) {
                        completeStreamingMessage(currentStreamingMessage, data);
                        currentStreamingMessage = null;
                    }
                    break;

                case 'terminated':
                    displayMessage(data.content, 'system');
                    if (currentStreamingMessage) {
                        completeStreamingMessage(currentStreamingMessage, {
                            content: "[响应已终止]",
                            token_count: 0,
                            character_count: 0
                        });
                        currentStreamingMessage = null;
                    }
                    enableControls();
                    isWaitingForResponse = false;
                    break;

                case 'error':
                    displayMessage(data.content, 'error');
                    enableControls();
                    isWaitingForResponse = false;
                    break;

                case 'system':
                    displayMessage(data.content, 'system');
                    break;
            }
        }

        /**
         * 创建流式消息元素
         * @returns {HTMLElement} 消息元素
         */
        function createStreamingMessage() {
            const messagesContainer = document.getElementById('messages');
            const messageElement = document.createElement('div');
            messageElement.className = 'message assistant streaming';

            const labelElement = document.createElement('div');
            labelElement.className = 'message-label';
            labelElement.textContent = '🤖 AI助手';

            const contentElement = document.createElement('div');
            contentElement.className = 'message-content';
            contentElement.textContent = '';

            messageElement.appendChild(labelElement);
            messageElement.appendChild(contentElement);
            messagesContainer.appendChild(messageElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            return messageElement;
        }

        /**
         * 向流式消息追加内容
         * @param {HTMLElement} messageElement - 消息元素
         * @param {string} content - 要追加的内容
         */
        function appendToStreamingMessage(messageElement, content) {
            const contentElement = messageElement.querySelector('.message-content');
            contentElement.textContent += content;

            // 自动滚动到底部
            const messagesContainer = document.getElementById('messages');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        /**
         * 完成流式消息显示
         * @param {HTMLElement} messageElement - 消息元素
         * @param {Object} data - 完成数据，包含令牌信息
         */
        function completeStreamingMessage(messageElement, data) {
            messageElement.classList.remove('streaming');

            // 添加令牌信息
            if (data.token_count !== undefined) {
                const tokenInfo = document.createElement('div');
                tokenInfo.className = 'token-info';
                tokenInfo.textContent = `📊 令牌: ${data.token_count} | 字符: ${data.character_count}`;
                messageElement.appendChild(tokenInfo);
            }
        }

        /**
         * 发送消息
         */
        function sendMessage() {
            const input = document.getElementById('message-input');
            const message = input.value.trim();

            // 检查输入和连接状态
            if (!message || !socket || socket.readyState !== WebSocket.OPEN) {
                if (!message) {
                    alert('请输入消息内容！');
                } else if (!socket || socket.readyState !== WebSocket.OPEN) {
                    alert('WebSocket连接未建立，请等待连接或刷新页面！');
                }
                return;
            }

            // 显示用户消息
            displayMessage(message, 'user');

            // 通过WebSocket发送消息
            socket.send(JSON.stringify({
                content: message,
                source: 'user'
            }));

            // 清空输入框并禁用控件
            input.value = '';
            disableControls();
            isWaitingForResponse = true;
        }

        /**
 * 终止聊天
 */
        async function terminateChat() {
            try {
                // 检查是否有正在进行的对话
                const hasActiveConversation = currentStreamingMessage || isWaitingForResponse;

                // 通过HTTP API终止所有活跃的聊天
                const response = await fetch('http://localhost:8001/terminate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const result = await response.json();

                    if (hasActiveConversation) {
                        displayMessage('⛔ 用户手动终止响应 - ' + result.status, 'system');

                        // 如果有正在流式显示的消息，立即完成它
                        if (currentStreamingMessage) {
                            completeStreamingMessage(currentStreamingMessage, {
                                content: "[用户手动终止]",
                                token_count: 0,
                                character_count: 0
                            });
                            currentStreamingMessage = null;
                        }

                        // 重新启用控件
                        enableControls();
                        isWaitingForResponse = false;
                    } else {
                        // 没有活跃对话时的提示
                        displayMessage('⛔ 终止信号已发送（当前没有活跃的对话）', 'system');
                    }
                } else {
                    displayMessage('❌ 终止请求失败', 'error');
                }
            } catch (error) {
                console.error('终止请求错误:', error);
                displayMessage('❌ 无法发送终止请求：' + error.message, 'error');
            }
        }

        /**
         * 禁用控件
         */
        function disableControls() {
            document.getElementById('message-input').disabled = true;
            document.getElementById('send-btn').disabled = true;
            // 终止按钮始终保持可用
            document.getElementById('terminate-btn').disabled = false;
        }

        /**
         * 启用控件
         */
        function enableControls() {
            const input = document.getElementById('message-input');
            const sendBtn = document.getElementById('send-btn');
            const terminateBtn = document.getElementById('terminate-btn');

            input.disabled = false;
            sendBtn.disabled = false;
            // 终止按钮始终保持可用
            terminateBtn.disabled = false;
            input.focus();  // 自动聚焦到输入框
        }

        /**
         * 显示消息
         * @param {string} content - 消息内容
         * @param {string} source - 消息来源（user/assistant/system/error）
         */
        function displayMessage(content, source) {
            const messagesContainer = document.getElementById('messages');
            const messageElement = document.createElement('div');
            messageElement.className = `message ${source}`;

            const labelElement = document.createElement('div');
            labelElement.className = 'message-label';

            // 根据来源设置不同的标签
            switch (source) {
                case 'user':
                    labelElement.textContent = '👤 用户';
                    break;
                case 'assistant':
                    labelElement.textContent = '🤖 AI助手';
                    break;
                case 'system':
                    labelElement.textContent = '⚙️ 系统';
                    break;
                case 'error':
                    labelElement.textContent = '❌ 错误';
                    break;
                default:
                    labelElement.textContent = source;
            }

            const contentElement = document.createElement('div');
            contentElement.className = 'message-content';
            contentElement.textContent = content;

            messageElement.appendChild(labelElement);
            messageElement.appendChild(contentElement);
            messagesContainer.appendChild(messageElement);

            // 自动滚动到底部
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        /**
         * 加载聊天历史
         */
        async function loadHistory() {
            try {
                const response = await fetch('http://localhost:8001/history');
                if (!response.ok) {
                    throw new Error('网络响应不正常');
                }
                const history = await response.json();

                // 清空消息容器
                document.getElementById('messages').innerHTML = '';

                // 显示历史消息
                history.forEach(message => {
                    displayMessage(message.content, message.source);
                });
            } catch (error) {
                console.error('加载历史记录时出错:', error);
                displayMessage('⚠️ 无法加载历史记录', 'system');
            }
        }

        // 事件监听器设置
        document.addEventListener('DOMContentLoaded', function () {
            // 回车键发送消息
            document.getElementById('message-input').addEventListener('keydown', function (event) {
                if (event.key === 'Enter' && !isWaitingForResponse) {
                    event.preventDefault();  // 防止表单提交
                    sendMessage();
                }
            });

            // 初始化按钮状态
            document.getElementById('message-input').disabled = false;
            document.getElementById('send-btn').disabled = false;
            document.getElementById('terminate-btn').disabled = false;  // 终止按钮始终可用

            // 页面加载时连接WebSocket
            connectWebSocket();

            // 显示欢迎消息
            setTimeout(() => {
                displayMessage('🎉 欢迎使用AutoGen AI助手！我可以为您提供各种帮助。终止按钮随时可用，点击可立即停止AI响应生成。', 'system');
            }, 1000);
        });

        // 页面卸载时清理WebSocket连接
        window.addEventListener('beforeunload', function () {
            if (socket) {
                socket.close();
            }
        });
    </script>
</body>

</html>